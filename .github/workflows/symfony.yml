# https://help.github.com/en/actions
name: CI process for Symfony
on:
    push:
    pull_request:
        branches:
            - main
            - dev

jobs:
    quality:
        name: Symfony Mapping Bundle (PHP ${{ matrix.php-versions }})
        runs-on: ubuntu-20.04
        strategy:
            fail-fast: true
            matrix:
                php-versions: ['8.0', '8.1', '8.2']

        steps:
            # —— Setup Github actions 🐙 —————————————————————————————————————————————
            # https://github.com/actions/checkout (official)
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  ref: ${{ github.head_ref }}
                  fetch-depth: 0

            # https://github.com/shivammathur/setup-php (community)
            - name: Setup PHP, extensions and composer with shivammathur/setup-php
              uses: shivammathur/setup-php@v2
              with:
                  php-version: ${{ matrix.php-versions }}
                  extensions: mbstring, xml, ctype, iconv, intl, pdo, pdo_mysql, dom, filter, gd, iconv, json
              env:
                  update: true

            - name: Check PHP Version
              run: php -v

            # —— Composer 🧙‍️ —————————————————————————————————————————————————————————
            - name: Validate composer.json and composer.lock
              run: composer validate

            - name: Cache Composer packages
              id: composer-cache
              uses: actions/cache@v4
              with:
                  path: vendor
                  key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-php-

            - name: Install Dependencies
              run: composer install -q --no-ansi --no-interaction --no-scripts --no-progress --prefer-dist

            ## —— Coding standards ✨ ————————————————————————————————————————————————
            - name: Coding standards checks (php-cs-fixer)
              run: ./vendor/bin/php-cs-fixer fix --dry-run --diff

            ## —— Static analysis ✨ —————————————————————————————————————————————————
            - name: Static analysis of PHP code (PHPStan)
              run: ./vendor/bin/phpstan --memory-limit=1G analyse

            ## —— Tests ✅ ———————————————————————————————————————————————————————————
#            - name: Load Doctrine fixtures
#              run: |
#                  bin/console .... load fixtures
#
            - name: Run functionnal and unit tests
              run: ./vendor/bin/phpunit

    security:
        name: composer security check (PHP ${{ matrix.php-versions }})
        runs-on: ubuntu-20.04
        strategy:
            fail-fast: true
            matrix:
                php-versions: [ '8.0', '8.1', '8.2' ]
        steps:
            - uses: actions/checkout@v4
            - uses: symfonycorp/security-checker-action@v4
